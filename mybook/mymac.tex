% Macros for My Book

\input luatexko.sty

% hangul font setting for plain tex
% borrowed from luatexko-doc.tex
%
\sethangulfont\tenmj="Noto Serif CJK KR Light:%
  language=KOR;%
  script=hang;%
  interhangul=-0.04em;%
  interlatincjk=.125em;%
  charraise=-0.06em;%
  +compresspunctuations;%
  expansion=default;" at 9.8pt
\sethangulfont\tentz="Noto Sans Mono CJK KR:%
  language=KOR;%
  script=hang;%
  interhangul=-0.04em;%
  interlatincjk=.125em;%
  charraise=-0.06em;%
  +compresspunctuations;%
  expansion=default;" at 9.5pt
\sethangulfont\tenbd="Noto Serif CJK KR Bold:%
  language=KOR;%
  script=hang;%
  interhangul=-0.04em;%
  interlatincjk=.125em;%
  charraise=-0.06em;%
  +compresspunctuations;%
  expansion=default;" at 9.8pt
\sethangulfont\tensn="Noto Sans CJK KR DemiLight:%
  language=KOR;%
  script=hang;%
  interhangul=-0.04em;%
  interlatincjk=.125em;%
  charraise=-0.06em;%
  +compresspunctuations;%
  +compresspunctuations" at 9.8pt

\sethangulfont\ninemj="Noto Serif CJK KR Light:%
  language=KOR;%
  script=hang;%
  interhangul=-0.04em;%
  interlatincjk=.125em;%
  charraise=-0.06em;%
  +compresspunctuations;%
  expansion=default" at 8.8pt
\sethangulfont\ninetz="Noto Sans Mono CJK KR:
  language=KOR;%
  script=hang;%
  interhangul=-0.04em;%
  interlatincjk=.125em;%
  charraise=-0.06em;%
  +compresspunctuations;%
  expansion=default;" at 8.5pt
\sethangulfont\ninebd="Noto Serif CJK KR Bold:%
  language=KOR;%
  script=hang;%
  interhangul=-0.04em;%
  interlatincjk=.125em;%
  charraise=-0.06em;%
  +compresspunctuations;%
  expansion=default" at 8.8pt
\sethangulfont\ninesn="Noto Sans CJK KR DemiLight:%
  language=KOR;%
  script=hang;%
  interhangul=-0.04em;%
  interlatincjk=.125em;%
  charraise=-0.06em;%
  +compresspunctuations;%
  expansion=default" at 8.8pt

\sethangulfont\eightmj="Noto Serif CJK KR Light:%
  language=KOR;%
  script=hang;%
  interhangul=-0.04em;%
  interlatincjk=.125em;%
  charraise=-0.06em;%
  +compresspunctuations;%
  expansion=default" at 7.8pt
\sethangulfont\eighttz="Noto Sans Mono CJK KR:%
  language=KOR;%
  script=hang;%
  interhangul=-0.04em;%
  interlatincjk=.125em;%
  charraise=-0.06em;%
  +compresspunctuations;%
  expansion=default" at 7.5pt
\sethangulfont\eightbd="Noto Serif CJK KR Bold:%
  language=KOR;%
  script=hang;%
  interhangul=-0.04em;%
  interlatincjk=.125em;%
  charraise=-0.06em;%
  +compresspunctuations;%
  expansion=default" at 7.8pt
\sethangulfont\eightsn="Noto Sans CJK KR DemiLight:%
  language=KOR;%
  script=hang;%
  interhangul=-0.04em;%
  interlatincjk=.125em;%
  charraise=-0.06em;%
  +compresspunctuations;%
  expansion=default" at 7.8pt

\sethangulfont\sevenmj="Noto Serif CJK KR Light:%
  language=KOR;%
  script=hang;%
  interhangul=-0.04em;%
  interlatincjk=.125em;%
  charraise=-0.06em;%
  +compresspunctuations;%
  expansion=default" at 6.8pt

\font\texthangul="Noto Sans CJK KR DemiLight" at 9.8pt
\font\texthangulnine="Noto Sans CJK KR DemiLight" at 8.8pt
\font\texthanguleight="Noto Sans CJK KR DemiLight" at 7.8pt
\font\scripthangul="Noto Sans CJK KR Regular" at 6.8pt
\font\scripthangulsix="Noto Sans CJK KR Regular" at 5.8pt
\font\scriptscripthangul="Noto Sans CJK KR Medium" at 4.8pt

% borrowed from manmac.tex
%
\catcode`@=11 % borrow the private macros of PLAIN (with care)

\font\tentex=cmtex10

\font\inchhigh=cminch
\font\titlefont="Noto Sans CJK KR Black" at 40pt
\font\sectitlefont="Noto Sans CJK KR Bold" at 18pt

\font\ninerm=cmr9
\font\eightrm=cmr8
\font\sixrm=cmr6

\font\ninei=cmmi9
\font\eighti=cmmi8
\font\sixi=cmmi6
\skewchar\ninei='177 \skewchar\eighti='177 \skewchar\sixi='177

\font\ninesy=cmsy9
\font\eightsy=cmsy8
\font\sixsy=cmsy6
\skewchar\ninesy='60 \skewchar\eightsy='60 \skewchar\sixsy='60

\font\eightss=cmssq8

\font\eightssi=cmssqi8

\font\ninebf=cmbx9
\font\eightbf=cmbx8
\font\sixbf=cmbx6

\font\ninett=cmtt9
\font\eighttt=cmtt8

\hyphenchar\tentt=-1 % inhibit hyphenation in typewriter type
\hyphenchar\ninett=-1
\hyphenchar\eighttt=-1

\font\ninesl=cmsl9
\font\eightsl=cmsl8

\font\nineit=cmti9
\font\eightit=cmti8

\font\tenu=cmu10 % unslanted text italic
\font\magnifiedfiverm=cmr5 at 10pt
\font\cmman=cmman % font used for miscellaneous Computer Modern variations

%
\newskip\ttglue
\def\tenpoint{\def\rm{\fam0\tenrm}%
  \textfont0=\tenrm \scriptfont0=\sevenrm \scriptscriptfont0=\fiverm
  \textfont1=\teni \scriptfont1=\seveni \scriptscriptfont1=\fivei
  \textfont2=\tensy \scriptfont2=\sevensy \scriptscriptfont2=\fivesy
  \textfont3=\tenex \scriptfont3=\tenex \scriptscriptfont3=\tenex
  \setmathhangulfonts\texthangul\scripthangul\scriptscripthangul
  \def\it{\fam\itfam\tenit}%
  \textfont\itfam=\tenit
  \def\sl{\fam\slfam\tensl}%
  \textfont\slfam=\tensl
  \def\bf{\fam\bffam\tenbf}%
  \textfont\bffam=\tenbf \scriptfont\bffam=\sevenbf
   \scriptscriptfont\bffam=\fivebf
  \def\tt{\fam\ttfam\tentt}%
  \textfont\ttfam=\tentt
  \expandafter\def\expandafter\rm\expandafter{\rm\tenmj}
  \expandafter\def\expandafter\tt\expandafter{\tt\tentz}
  \expandafter\def\expandafter\bf\expandafter{\bf\tenbd}
  \expandafter\def\expandafter\sl\expandafter{\sl\tensn}
  \expandafter\def\expandafter\it\expandafter{\it\tensn}  
  \tt \ttglue=.5em plus.25em minus.15em
  \normalbaselineskip=15pt
  \let\sc=\eightrm
  \let\big=\tenbig
  \setbox\strutbox=\hbox{\vrule height8.5pt depth3.5pt width\z@}%
  \normalbaselines\rm}

\def\ninepoint{\def\rm{\fam0\ninerm}%
  \textfont0=\ninerm \scriptfont0=\sixrm \scriptscriptfont0=\fiverm
  \textfont1=\ninei \scriptfont1=\sixi \scriptscriptfont1=\fivei
  \textfont2=\ninesy \scriptfont2=\sixsy \scriptscriptfont2=\fivesy
  \textfont3=\tenex \scriptfont3=\tenex \scriptscriptfont3=\tenex
  \setmathhangulfonts\texthangulnine\scripthangulsix\scriptscripthangul
  \def\it{\fam\itfam\nineit}%
  \textfont\itfam=\nineit
  \def\sl{\fam\slfam\ninesl}%
  \textfont\slfam=\ninesl
  \def\bf{\fam\bffam\ninebf}%
  \textfont\bffam=\ninebf \scriptfont\bffam=\sixbf
   \scriptscriptfont\bffam=\fivebf
  \def\tt{\fam\ttfam\ninett}%
  \textfont\ttfam=\ninett
  \expandafter\def\expandafter\rm\expandafter{\rm\ninemj}  
  \expandafter\def\expandafter\tt\expandafter{\tt\ninetz}
  \expandafter\def\expandafter\bf\expandafter{\bf\ninebd}
  \expandafter\def\expandafter\sl\expandafter{\sl\ninesn}
  \expandafter\def\expandafter\it\expandafter{\it\ninesn}  
  \tt \ttglue=.5em plus.25em minus.15em
  \normalbaselineskip=13pt
  \let\sc=\sevenrm
  \let\big=\ninebig
  \setbox\strutbox=\hbox{\vrule height8pt depth3pt width\z@}%
  \normalbaselines\rm}

\def\eightpoint{\def\rm{\fam0\eightrm}%
  \textfont0=\eightrm \scriptfont0=\sixrm \scriptscriptfont0=\fiverm
  \textfont1=\eighti \scriptfont1=\sixi \scriptscriptfont1=\fivei
  \textfont2=\eightsy \scriptfont2=\sixsy \scriptscriptfont2=\fivesy
  \textfont3=\tenex \scriptfont3=\tenex \scriptscriptfont3=\tenex
  \setmathhangulfonts\texthanguleight\scripthangulsix\scriptscripthangul
  \def\it{\fam\itfam\eightit}%
  \textfont\itfam=\eightit
  \def\sl{\fam\slfam\eightsl}%
  \textfont\slfam=\eightsl
  \def\bf{\fam\bffam\eightbf}%
  \textfont\bffam=\eightbf \scriptfont\bffam=\sixbf
   \scriptscriptfont\bffam=\fivebf
  \def\tt{\fam\ttfam\eighttt}%
  \textfont\ttfam=\eighttt
  \expandafter\def\expandafter\rm\expandafter{\rm\eightmj}  
  \expandafter\def\expandafter\tt\expandafter{\tt\eighttz}
  \expandafter\def\expandafter\bf\expandafter{\bf\eightbd}
  \expandafter\def\expandafter\sl\expandafter{\sl\eightsn}
  \expandafter\def\expandafter\it\expandafter{\it\eightsn}  
  \tt \ttglue=.5em plus.25em minus.15em
  \normalbaselineskip=11pt
  \let\sc=\sixrm
  \let\big=\eightbig
  \setbox\strutbox=\hbox{\vrule height7pt depth2pt width\z@}%
  \normalbaselines\rm}

\def\tenmath{\tenpoint\fam-1 } % use after $ in ninepoint sections
\def\tenbig#1{{\hbox{$\left#1\vbox to8.5pt{}\right.\n@space$}}}
\def\ninebig#1{{\hbox{$\textfont0=\tenrm\textfont2=\tensy
  \left#1\vbox to7.25pt{}\right.\n@space$}}}
\def\eightbig#1{{\hbox{$\textfont0=\ninerm\textfont2=\ninesy
  \left#1\vbox to6.5pt{}\right.\n@space$}}}

% Page layout
\newdimen\pagewidth \newdimen\pageheight \newdimen\ruleht
\hsize 29pc  \vsize 46pc  \maxdepth=2.2pt
\pagewidth=\hsize \pageheight=\vsize \ruleht=.5pt
\abovedisplayskip=6pt plus 3pt minus 1pt
\belowdisplayskip=6pt plus 3pt minus 1pt
\abovedisplayshortskip=0pt plus 3pt
\belowdisplayshortskip=4pt plus 3pt

%\newinsert\footins
\def\footnote#1{\edef\@sf{\spacefactor\the\spacefactor}#1\@sf
      \insert\footins\bgroup\eightpoint
      \interlinepenalty100 \let\par=\endgraf
        \leftskip=\z@skip \rightskip=\z@skip
        \splittopskip=10pt plus 1pt minus 1pt \floatingpenalty=20000
        \smallskip\item{#1}\bgroup\strut\aftergroup\@foot\let\next}
\skip\footins=12pt plus 2pt minus 4pt % space added when footnote is present
%\count\footins=1000 % footnote magnification factor (1 to 1)
\dimen\footins=30pc % maximum footnotes per page

\newinsert\margin
\dimen\margin=\maxdimen
\count\margin=0 \skip\margin=0pt % marginal inserts take up no space

\newif\iftitle
\def\titlepage{\global\titletrue} % for pages without headlines
\def\rhead{} % \rhead contains the running headline

\def\leftheadline{\hbox to \pagewidth{\spaceskip=0pt
    \vbox to 10pt{}% strut to position the baseline
    \llap{\tenbf\folio\kern1pc}% folio to left of text
    \tenit\rhead\hfil% running head flush left
    }}
\def\rightheadline{\hbox to \pagewidth{\spaceskip=0pt
    \vbox to 10pt{}% strut to position the baseline
    \hfil\tenit\rhead\/% running head flush right
    \rlap{\kern1pc\tenbf\folio}% folio to right of text
    }}

\def\onepageout#1{\shipout\vbox{ % here we define one page of output
    \offinterlineskip % butt the boxes together
    \vbox to 3pc{ % this part goes on top of the 44pc pages
      \iftitle % the next is used for title pages
        \global\titlefalse % reset the titlepage switch
        \setcornerrules % for camera alignment
      \else\ifodd\pageno \rightheadline\else\leftheadline\fi\fi
      \vfill} % this completes the \vbox to 3pc
    \vbox to \pageheight{
      \ifvoid\margin\else % marginal info is present
        \rlap{\kern31pc\vbox to\z@{\kern4pt\box\margin \vss}}\fi
      #1 % now insert the main information
      \ifvoid\footins\else % footnote info is present
        \vskip\skip\footins \kern-3pt
        \hrule height\ruleht width\pagewidth \kern-\ruleht \kern3pt
        \unvbox\footins\fi
      \boxmaxdepth=\maxdepth
      } % this completes the \vbox to \pageheight
    }
  \advancepageno}

\def\setcornerrules{\hbox to \pagewidth{\vrule width 1pc height\ruleht
    \hfil \vrule width 1pc}
  \hbox to \pagewidth{\llap{\sevenrm(page \folio)\kern1pc}%
    \vrule height1pc width\ruleht depth\z@
    \hfil \vrule width\ruleht depth\z@}}

\output{\onepageout{\unvbox255}}

% Chapter formatting
% The preface and table of contents are formatted in place, not here

\newcount\exno % for the number of exercises in the current chapter
\newcount\subsecno % for the number of subsections in the current chapter

\def\beginchapter#1 #2#3. #4\par{\global\exno=0
  \subsecno=0
  \def\chapno{#2#3}
  \ifodd\pageno
    \errmessage{You had too much text on that last page; I'm backing up}
    \advance\pageno by-1 \fi
  \titlepage
  \def\\{ } % \\'s in the title will be treated as spaces
  \message{#1 #2#3:} % show the chapter title on the terminal
  \xdef\rhead{#1 #2#3: #4\unskip}
  {\def\\{#3}
    \ifx\empty\\ \rightline{\inchhigh #2\kern-.04em}
    \else\rightline{\inchhigh #2\kern-.06em#3\kern-.04em}\fi
    \vskip 1.75pc
    \baselineskip 36pt \lineskiplimit \titlelsl \lineskip 12pt
    \let\\=\cr % now the \\'s are line dividers
    \halign{\line{\titlefont\hfil##}\\#4\unskip\\}
    \vfill\eject} % output the chapter title page
  \tenpoint
  \noindent\ignorespaces} % the first paragraph of a chapter is not indented
\newdimen\titlelsl \titlelsl=1pt

\outer\def\endchapter{\ifodd\pageno \else\vfill\eject\null\fi
  \begingroup\bigskip\vfill % beginning of the quotes
  \def\eject{\endgroup\eject}
  \def\par{\ifhmode\/\endgraf\fi}\obeylines
  \eightpoint \let\tt=\ninett
  \baselineskip 14pt
  \parfillskip \z@
  \interlinepenalty 10000
  \leftskip \z@ plus 40pc minus \parindent
  \let\rm=\eightss \let\sl=\eightssi
  \everypar{\sl}}
\def\author#1(#2){\smallskip\noindent\rm--- #1\unskip\enspace(#2)}

\def\.#1{\leavevmode\hbox{\tentex % typewriter type for strings
  \let\\=\BS % backslash in a string
  \let\{=\LB % left brace in a string
  \let\}=\RB % right brace in a string
  \let\~=\TL % tilde in a string
  \let\ =\SP % space in a string
  \let\_=\UL % underline in a string
  \let\&=\AM % ampersand in a string
  \let\^=\CF % circumflex in a string
  #1\kern.05em}}
\chardef\AM=`\& % ampersand character in a string
\chardef\BS=`\\ % backslash in a string
\chardef\LB=`\{ % left brace in a string
\chardef\RB=`\} % right brace in a string
\def\SP{{\tt\char`\ }} % (visible) space in a string
\chardef\TL=`\~ % tilde in a string
\chardef\UL=`\_ % underline character in a string
\chardef\CF=`\^ % circumflex character in a string

\def\PP{\hbox{\kern.5pt\raise1pt\hbox{\sevenrm+\kern-1pt+}\kern.5pt}}
\def\alg#1{{Algorithm\kern1pt\hbox{#1}}}
\def\ltdot{\mathinner{\ldotp\ldotp}}

% framing
\def\frame #1#2#3{\vbox{\hrule height#1pt%    TOP RULE
  \hbox{\vrule width#1pt\kern #2pt%            RULE AND SPACE ON LEFT
  \vbox{\kern #2pt\hbox{#3}\kern #2pt}%        TOP, MATERIAL, BOTTOM
  \kern #2pt\vrule width#1pt}%                 SPACE AND RULE ON RIGHT
  \hrule height0pt depth#1pt}}%                BOTTOM RULE

% verbatim scanning
\def\verbatim{\begingroup
  \def\do##1{\catcode`##1=12 } \dospecials
  \parskip 0pt \parindent 0pt \let\!=!
  \catcode`\ =13 \catcode`\^^M=13
  \tt \catcode`\!=0 \verbatimdefs \verbatimgobble}
{\catcode`\^^M=13{\catcode`\ =13\gdef\verbatimdefs{\def^^M{\ \par}\let =\ }} %
  \gdef\verbatimgobble#1^^M{}}

% non-centered displays
\outer\def\begindisplay{\obeylines\startdisplay}
{\obeylines\gdef\startdisplay#1
  {\catcode`\^^M=5$$#1\halign\bgroup\indent##\hfil&&\qquad##\hfil\cr}}
\outer\def\enddisplay{\crcr\egroup$$}

% Token for \aftergroup to reset color
\def\colorstackpop{\pdfextension colorstack 0 pop}
\def\setcmykcolor#1{%
  \pdfextension colorstack 0 push {#1 k #1 K}%
  \aftergroup\colorstackpop
}
\def\setrgbcolor#1{%
  \pdfextension colorstack 0 push {#1 rg #1 RG}%
  \aftergroup\colorstackpop
}
\def\black{\setcmykcolor{0 0 0 1}}
\def\blue{\setcmykcolor{1 1 0 0}}
\def\red{\setrgbcolor{0.8 0 0}}

% include graphics
% usage: \includegraphics width 3cm height 5cm {donknuth.png}
\def\includegraphics#1#{%
  \def\next{%
    \unless\ifcsname PicKey #1 \the\toks0\endcsname
      \immediate\saveimageresource #1 {\the\toks0}%
      \expandafter\xdef\csname PicKey #1 \the\toks0\endcsname{\the\lastsavedimageresourceindex}%
    \fi
    \expandafter\useimageresource\csname PicKey #1 \the\toks0\endcsname\relax}%
  \afterassignment\next\toks0= }

% macros to demarcate lines quoted from TeX source files
\def\beginlines{\par\begingroup\nobreak\medskip\parindent\z@ \obeylines
  \hrule\kern1pt\nobreak \everypar{\strut}}
\def\endlines{\kern1pt\hrule\endgroup\medbreak\noindent}
\def\weakendlines{\kern1pt\hrule\endgroup\medskip\noindent}
\def\finalendlines{\kern1pt\hrule\endgroup\medbreak}

% Indexing macros
\newif\ifproofmode
\proofmodetrue % this should be false when making camera-ready copy
\newwrite\inx
\immediate\openout\inx=index % file for index reminders
\newif\ifsilent
\def\specialhat{\ifmmode\def\next{^}\else\let\next=\beginxref\fi\next}
\def\beginxref{\futurelet\next\beginxrefswitch}
\def\beginxrefswitch{\ifx\next\specialhat\let\next=\silentxref
  \else\silentfalse\let\next=\xref\fi \next}
\catcode`\^=\active \let ^=\specialhat
\def\silentxref^{\silenttrue\xref}

\def\marginstyle{\vrule height7pt depth2pt width\z@ \sevenrm\sevenmj}

\chardef\bslash=`\\
\def\xref{\futurelet\next\xrefswitch}
\def\xrefswitch{\begingroup
  \ifx\next|\aftergroup\vxref % case 1 or 2, |arg| or |\arg|
  \else\ifx\next\<\aftergroup\anglexref % case 3, "\<arg>" means angle brackets
    \else\aftergroup\normalxref \fi\fi\endgroup} % case 0, "{arg}"
\def\vxref|{\catcode`\\=\active \futurelet\next\vxrefswitch}
\def\vxrefswitch#1|{\catcode`\\=0
  \ifx\next\empty\def\xreftype{2}%
    \def\next{{\tt\bslash\text}}% type 2, |\arg|
  \else\def\xreftype{1}\def\next{{\tt\text}}\fi % type 1, |arg|
  \edef\text{#1}\makexref}
{\catcode`\|=0 \catcode`\\=\active |gdef\{}}
\def\anglexref\<#1>{\def\xreftype{3}\def\text{#1}%
  \def\next{\<\text>}\makexref}
\def\normalxref#1{\def\xreftype{0}\def\text{#1}\let\next=\text\makexref}
\def\makexref{\ifproofmode\insert\margin{\hbox{\marginstyle\text}}%
   \xdef\writeit{\write\inx{\text\space!\xreftype\space
     \noexpand\number\pageno.}}\writeit
   \else\ifhmode\kern\z@\fi\fi
  \ifsilent\ignorespaces\else\next\fi}
% the \insert (which is done in proofmode only) suppresses hyphenation,
% so the \kern\z@ is put in to give the same effect in non-proofmode.

\catcode`\@=12
\tenpoint
